import React, { useState, useEffect } from 'react'
import { Button } from './ui/button'
import { Menu, X, Phone, ChevronDown } from 'lucide-react'
import { toast } from 'sonner@2.0.3'
import signpostIcon from 'figma:asset/58fd4f69a51421613c7ba5f5d06fc265053f4179.png'

interface HeaderProps {
  onNavigateToServices?: () => void
  onNavigateToCruises?: () => void
  onNavigateToTravelOptions?: () => void
  onNavigateToContact?: () => void
  onNavigateToStories?: () => void
  onNavigateToAbout?: () => void
  onNavigateToAI?: () => void
  onNavigateToHome?: () => void
  forceBlue?: boolean
}

export default function Header({ onNavigateToServices, onNavigateToCruises, onNavigateToTravelOptions, onNavigateToContact, onNavigateToStories, onNavigateToAbout, onNavigateToAI, onNavigateToHome, forceBlue = false }: HeaderProps) {
  const [isScrolled, setIsScrolled] = useState(false)
  const [isMobileMenuOpen, setIsMobileMenuOpen] = useState(false)
  const [scrollProgress, setScrollProgress] = useState(0)
  const [activeDropdown, setActiveDropdown] = useState<string | null>(null)
  
  const handlePhoneClick = () => {
    const phoneNumber = '61 415 355 851'
    // Copy to clipboard
    navigator.clipboard.writeText(phoneNumber).then(() => {
      toast.success(`Phone number copied: ${phoneNumber}`, {
        description: 'Click to call or paste anywhere',
        duration: 4000,
      })
    }).catch(() => {
      // Fallback for older browsers
      toast.success(`Call us: ${phoneNumber}`, {
        description: 'Phone number ready to dial',
        duration: 4000,
      })
    })
  }

  useEffect(() => {
    const handleScroll = () => {
      const scrollPosition = window.scrollY
      const documentHeight = document.documentElement.scrollHeight - window.innerHeight
      const progress = (scrollPosition / documentHeight) * 100
      
      setIsScrolled(scrollPosition > 100)
      setScrollProgress(Math.min(progress, 100))
    }

    window.addEventListener('scroll', handleScroll, { passive: true })
    return () => window.removeEventListener('scroll', handleScroll)
  }, [])

  const toggleMobileMenu = () => {
    setIsMobileMenuOpen(!isMobileMenuOpen)
    setActiveDropdown(null)
  }

  const handleDropdownToggle = (dropdown: string) => {
    setActiveDropdown(activeDropdown === dropdown ? null : dropdown)
  }

  const handleNavClick = (href: string) => {
    if (href === '#home') {
      if (onNavigateToHome) {
        onNavigateToHome()
      } else {
        window.scrollTo({ top: 0, behavior: 'smooth' })
      }
      toggleMobileMenu()
      return
    }
    
    if (href === '/cruises') {
      if (onNavigateToCruises) {
        onNavigateToCruises()
      }
      toggleMobileMenu()
      return
    }
    
    if (href === '/travel-options') {
      if (onNavigateToTravelOptions) {
        onNavigateToTravelOptions()
      }
      toggleMobileMenu()
      return
    }
    
    if (href === '/contact') {
      if (onNavigateToContact) {
        onNavigateToContact()
      }
      toggleMobileMenu()
      return
    }
    
    if (href === '/stories') {
      if (onNavigateToStories) {
        onNavigateToStories()
      }
      toggleMobileMenu()
      return
    }
    
    if (href === '/about') {
      if (onNavigateToAbout) {
        onNavigateToAbout()
      }
      toggleMobileMenu()
      return
    }
    
    if (href === '/ai-planner') {
      if (onNavigateToAI) {
        onNavigateToAI()
      }
      toggleMobileMenu()
      return
    }

    // Handle cross-page anchor navigation (services#travelinsurance)
    if (href.includes('#') && href.startsWith('/')) {
      const [page, anchor] = href.split('#')
      
      // If we're already on the target page, just scroll to anchor
      const element = document.querySelector(`#${anchor}`)
      if (element) {
        element.scrollIntoView({ behavior: 'smooth' })
        toggleMobileMenu()
        return
      }
      
      // If we're on a different page, navigate and then scroll
      if (page === '/cruises' && onNavigateToCruises) {
        onNavigateToCruises()
        setTimeout(() => {
          const element = document.querySelector(`#${anchor}`)
          if (element) {
            element.scrollIntoView({ behavior: 'smooth' })
          }
        }, 100)
      } else if (page === '/travel-options' && onNavigateToTravelOptions) {
        onNavigateToTravelOptions()
        setTimeout(() => {
          const element = document.querySelector(`#${anchor}`)
          if (element) {
            element.scrollIntoView({ behavior: 'smooth' })
          }
        }, 100)
      } else if (page === '/stories' && onNavigateToStories) {
        onNavigateToStories()
        setTimeout(() => {
          const element = document.querySelector(`#${anchor}`)
          if (element) {
            element.scrollIntoView({ behavior: 'smooth' })
          }
        }, 100)
      } else if (page === '/about' && onNavigateToAbout) {
        onNavigateToAbout()
        setTimeout(() => {
          const element = document.querySelector(`#${anchor}`)
          if (element) {
            element.scrollIntoView({ behavior: 'smooth' })
          }
        }, 100)
      }
      toggleMobileMenu()
      return
    }
    
    // Handle same-page anchor navigation
    if (href.startsWith('#')) {
      const element = document.querySelector(href)
      if (element) {
        element.scrollIntoView({ behavior: 'smooth' })
      }
      toggleMobileMenu()
    }
  }

  // Updated navigation structure with separate cruise and other travel pages
  const navigationItems = [
    { 
      name: 'Home', 
      href: '#home'
    },
    { 
      name: 'About Us', 
      href: '/about'
    },
    { 
      name: 'Cruises', 
      href: '/cruises'
    },
    { 
      name: 'Travel Options', 
      href: '/travel-options'
    },
    { 
      name: 'TravLin Stories', 
      href: '/stories'
    },
    { 
      name: 'Contact Us', 
      href: '/contact'
    }
  ]

  return (
    <header 
      className={`fixed top-0 left-0 right-0 z-50 transition-all duration-300 ${
        isScrolled || forceBlue ? 'header-scrolled' : 'header-transparent'
      }`}
    >
      <div className="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
        <div className="relative flex items-center justify-between h-16 sm:h-18 lg:h-20">
          {/* Brand - Signpost Icon Only */}
          <div className="flex items-center flex-shrink-0">
            <button 
              className="flex items-center" 
              onClick={() => {
                if (onNavigateToHome) {
                  onNavigateToHome()
                } else {
                  window.scrollTo({ top: 0, behavior: 'smooth' })
                }
              }}
            >
              <img 
                src={signpostIcon}
                alt="TravLin Travel"
                className="h-10 w-10 sm:h-12 sm:w-12 lg:h-14 lg:w-14 hover:scale-110 transition-transform duration-300 drop-shadow-lg cursor-pointer"
              />
            </button>
          </div>

          {/* Center Title - Explore Dream Discover */}
          <div className="absolute left-1/2 transform -translate-x-1/2 hidden md:block pointer-events-none">
            <div className="text-center">
              <p 
                className="text-sm lg:text-lg font-bold tracking-wider uppercase drop-shadow-md transition-colors duration-300 whitespace-nowrap"
                style={{ color: 'var(--brand-yellow)' }}
              >
                Explore • Dream • Discover
              </p>
            </div>
          </div>
          
          {/* CTA and Menu Button - ALL SCREEN SIZES */}
          <div className="flex items-center gap-2 sm:gap-3">
            <Button 
              className="px-2 py-2 sm:px-3 sm:py-2 lg:px-4 lg:py-3 xl:px-6 xl:py-3 rounded-lg font-bold uppercase tracking-wide text-xs lg:text-sm transition-all duration-300 shadow-lg min-h-[40px] lg:min-h-[44px] touch-manipulation"
              style={{
                backgroundColor: 'var(--brand-orange)',
                color: 'white',
                border: 'none'
              }}
              onClick={handlePhoneClick}
              onMouseEnter={(e) => {
                e.currentTarget.style.backgroundColor = 'var(--brand-orange-dark)';
                if (window.innerWidth >= 1024) {
                  e.currentTarget.style.transform = 'scale(1.05)';
                  e.currentTarget.style.boxShadow = '0 8px 32px rgba(237, 125, 49, 0.4)';
                }
              }}
              onMouseLeave={(e) => {
                e.currentTarget.style.backgroundColor = 'var(--brand-orange)';
                if (window.innerWidth >= 1024) {
                  e.currentTarget.style.transform = 'scale(1)';
                  e.currentTarget.style.boxShadow = '0 4px 20px rgba(237, 125, 49, 0.3)';
                }
              }}
            >
              <Phone className="w-4 h-4 lg:w-5 lg:h-5 text-white" style={{ fill: 'white', stroke: 'white', strokeWidth: '2px' }} />
            </Button>
            
            <button 
              className="text-white p-2 lg:p-3 hover:bg-white/10 rounded-md transition-colors duration-300 min-h-[40px] min-w-[40px] lg:min-h-[44px] lg:min-w-[44px] touch-manipulation flex items-center justify-center"
              onClick={toggleMobileMenu}
              style={{ color: (isScrolled || forceBlue) ? 'var(--white)' : 'var(--brand-yellow)' }}
            >
              {isMobileMenuOpen ? (
                <X className="w-5 h-5 sm:w-6 sm:h-6 lg:w-7 lg:h-7 drop-shadow-md" />
              ) : (
                <Menu className="w-5 h-5 sm:w-6 sm:h-6 lg:w-7 lg:h-7 drop-shadow-md" />
              )}
            </button>
          </div>
        </div>

        {/* Hamburger Menu - ALL SCREEN SIZES */}
        {isMobileMenuOpen && (
          <div className="absolute top-full left-0 right-0 bg-gray-900/95 backdrop-blur-md border-t border-white/10 shadow-2xl max-h-[calc(100vh-4rem)] lg:max-h-[calc(100vh-5rem)] overflow-y-auto">
            <nav className="flex flex-col p-4 sm:p-6 lg:p-8 space-y-1">
              {navigationItems.map((item) => (
                <div key={item.name} className="border-b border-white/10">
                  {/* Main Navigation Item */}
                  <div className="flex items-center justify-between">
                    <button
                      onClick={() => handleNavClick(item.href)}
                      className="font-medium uppercase tracking-wide text-sm lg:text-base transition-colors duration-300 py-4 lg:py-5 text-left touch-manipulation hover:text-orange-400 flex-grow"
                      style={{ color: item.name === 'Home' ? '#FFC000' : '#FFFFFF' }}
                    >
                      {item.name}
                    </button>
                    {/* Dropdown Toggle for items with subItems */}
                    {item.subItems && (
                      <button
                        onClick={() => handleDropdownToggle(item.name)}
                        className="p-2 text-white hover:text-orange-400 transition-colors duration-300"
                      >
                        <ChevronDown 
                          className={`w-4 h-4 transform transition-transform duration-200 ${
                            activeDropdown === item.name ? 'rotate-180' : ''
                          }`} 
                        />
                      </button>
                    )}
                  </div>
                  
                  {/* Sub-navigation Items */}
                  {item.subItems && activeDropdown === item.name && (
                    <div className="pl-4 pb-2 space-y-1">
                      {item.subItems.map((subItem) => (
                        <button
                          key={subItem.name}
                          onClick={() => handleNavClick(subItem.href)}
                          className="block text-sm text-gray-300 hover:text-orange-400 transition-colors duration-300 py-2 text-left w-full touch-manipulation"
                        >
                          • {subItem.name}
                        </button>
                      ))}
                    </div>
                  )}
                </div>
              ))}
            </nav>
          </div>
        )}
      </div>
      
      {/* Scroll Progress Indicator */}
      <div 
        className="absolute bottom-0 left-0 h-1 bg-gradient-to-r from-orange-500 via-yellow-500 to-blue-500 transition-all duration-300 ease-out" 
        style={{ width: `${scrollProgress}%` }} 
      />
    </header>
  )
}